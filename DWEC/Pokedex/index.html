<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Batalla Pokémon 2 Jugadores</title>
    <link rel="stylesheet" href="css/tablero.css">
    <script src="https://unpkg.com/vue@3.5.13/dist/vue.global.js"></script>
</head>

<body>
    <div class="contenedor" id="app">
        <div class="tablero">
            <!-- Selector de modo de juego -->
            <div>
                <label for="modoJuego">Selecciona el modo de juego:</label>
                <select v-model="modoJuego">
                    <option value="persona">Jugador vs Jugador</option>
                    <option value="maquina">Jugador vs Máquina</option>
                </select>
            </div>

            <!-- Jugador 1 -->
            <div class="fila fila-superior">
                <button class="boton-eleccion" @click="mostrarModal('J1')">Jugador 1</button>
                <div v-for="(pokemon, index) in pockemonsJ1" :key="'J1-'+index" class="carta"
                    @dragstart="dragStart('J1', index)" 
                    :draggable="iniciarJuego && !pokemon.dead"
                    :class="{'lost': pokemon.dead}">
                    <img :src="pokemon.img" :alt="pokemon.name">
                    <span>{{ pokemon.name }}</span>
                </div>
            </div>

            <!-- Zona de batalla -->
            <div class="fila fila-media">
                <button class="boton-musica" @click="inmuted = !inmuted">
                    <img v-if="inmuted" src="img/pause.svg" alt="Pausar">
                    <img v-else src="img/play-button.png" alt="Reproducir">
                </button>
                <div class="carta" @dragover.prevent @drop="dropCard('J1')">
                    <img v-if="cartaJ1" :src="cartaJ1.img" :alt="cartaJ1.name">
                    <div v-else>Jugador 1</div>
                </div>
                <div class="vs"></div>
                <div class="carta" @dragover.prevent @drop="dropCard('J2')">
                    <img v-if="cartaJ2" :src="cartaJ2.img" :alt="cartaJ2.name">
                    <div v-else>Jugador 2</div>
                </div>
            </div>

            <!-- Jugador 2 -->
            <div class="fila fila-inferior">
                <button class="boton-eleccion" @click="mostrarModal('J2')">Jugador 2</button>
                <div v-for="(pokemon, index) in pockemonsJ2" :key="'J2-'+index" class="carta"
                    @dragstart="dragStart('J2', index)"
                    :draggable="iniciarJuego && !pokemon.dead"
                    :class="{'lost': pokemon.dead}">
                    <img :src="pokemon.img" :alt="pokemon.name">
                    <span>{{ pokemon.name }}</span>
                </div>
            </div>

            <!-- Modal de selección -->
            <div class="modal" v-if="mostrarModalJ1 || mostrarModalJ2">
                <div class="modal-contenido">
                    <h2>Selecciona 5 Pokémon ({{ jugadorActual }})</h2>
                    <button @click="seleccionarAleatorio">Seleccionar Aleatorio</button>
                    <div class="pokemon-lista">
                        <div v-for="pokemon in pockemonsDisponibles" :key="pokemon.name"
                            class="pokemon-item" 
                            :class="{'seleccionado': seleccionados.includes(pokemon)}"
                            @click="toggleSeleccion(pokemon)">
                            <img :src="pokemon.img" :alt="pokemon.name">
                            <p>{{ pokemon.name }}</p>
                        </div>
                    </div>
                    <button @click="confirmarSeleccion" :disabled="seleccionados.length < 5">
                        Confirmar ({{ seleccionados.length }}/5)
                    </button>
                    <button @click="cerrarModal">Cancelar</button>
                </div>
            </div>

            <!-- Modal de batalla -->
            <div class="modal" v-if="mostrarBatalla">
                <div class="modal-contenido">
                    <h2>Batalla!</h2>
                    <div class="combate">
                        <div class="combatiente" :class="{'turno': turno === 'J1'}">
                            <img :src="cartaJ1.img" :alt="cartaJ1.name">
                            <div>Vida: {{ vidaJ1 }}/{{ cartaJ1.hp }}</div>
                        </div>
                        <div class="vs">VS</div>
                        <div class="combatiente" :class="{'turno': turno === 'J2'}">
                            <img :src="cartaJ2.img" :alt="cartaJ2.name">
                            <div>Vida: {{ vidaJ2 }}/{{ cartaJ2.hp }}</div>
                        </div>
                    </div>
                    
                    <div class="registro">
                        <div v-for="(evento, i) in registro" :key="i">{{ evento }}</div>
                    </div>

                    <div v-if="!batallaTerminada">
                        <h3>{{ turno }} selecciona ataque:</h3>
                        <div class="ataques">
                            <button v-for="(ataque, i) in ataquesActuales" :key="i"
                                @click="realizarAtaque(ataque)">
                                {{ ataque.name }} ({{ ataque.power }})
                            </button>
                        </div>
                    </div>
                    <div v-else>
                        <h2 class="resultado">{{ resultado }}</h2>
                        <button @click="cerrarBatalla">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>

        <audio v-if="inmuted" :src="`audios/${pistaAudio}`" autoplay loop></audio>
    </div>

    <script>
        Vue.createApp({
            data() {
                return {
                    // Estados del juego
                    iniciarJuego: false,
                    inmuted: true,
                    pistaAudio: "inicio.mp3",
                    
                    // Jugadores
                    pockemonsJ1: [],
                    pockemonsJ2: [],
                    jugadorActual: 'J1',
                    mostrarModalJ1: false,
                    mostrarModalJ2: false,
                    seleccionados: [],
                    modoJuego: 'persona', // Modo de juego por defecto
                    
                    // Batalla
                    cartaJ1: null,
                    cartaJ2: null,
                    mostrarBatalla: false,
                    vidaJ1: 0,
                    vidaJ2: 0,
                    turno: 'J1',
                    registro: [],
                    batallaTerminada: false,
                    resultado: '',
                    
                    // Datos Pokémon
                    pockemons: [],
                    pockemonsDisponibles: []
                }
            },
            computed: {
                ataquesActuales() {
                    return this.turno === 'J1' 
                        ? this.cartaJ1.movesWithPower 
                        : this.cartaJ2.movesWithPower;
                }
            },
            methods: {
                async ObtenerPokemons() {
                    const response = await fetch("https://pokeapi.co/api/v2/pokemon?limit=151");
                    const data = await response.json();
                    this.pockemons = await Promise.all(data.results.map(async (pokemon) => {
                        const res = await fetch(pokemon.url);
                        const datos = await res.json();
                        return {
                            name: datos.name,
                            img: datos.sprites.other.dream_world.front_default,
                            hp: datos.stats[0].base_stat,
                            attack: datos.stats[1].base_stat,
                            defense: datos.stats[2].base_stat,
                            moves: datos.moves,
                            movesWithPower: [],
                            dead: false
                        };
                    }));
                    this.pockemonsDisponibles = [...this.pockemons];
                },

                // Selección de Pokémon
                mostrarModal(jugador) {
                    this.jugadorActual = jugador;
                    this.seleccionados = jugador === 'J1' 
                        ? [...this.pockemonsJ1] 
                        : [...this.pockemonsJ2];
                    
                    jugador === 'J1' 
                        ? this.mostrarModalJ1 = true 
                        : this.mostrarModalJ2 = true;
                },

                toggleSeleccion(pokemon) {
                    if (this.seleccionados.includes(pokemon)) {
                        this.seleccionados = this.seleccionados.filter(p => p !== pokemon);
                    } else if (this.seleccionados.length < 5) {
                        this.seleccionados.push(pokemon);
                    }
                },

                async seleccionarAleatorio() {
                    this.seleccionados = [];
                    const disponibles = [...this.pockemonsDisponibles];
                    while (this.seleccionados.length < 5 && disponibles.length > 0) {
                        const index = Math.floor(Math.random() * disponibles.length);
                        this.seleccionados.push(disponibles.splice(index, 1)[0]);
                    }
                },

                async seleccionarAleatorioMaquina() {
                    this.pockemonsJ2 = [];
                    const disponibles = [...this.pockemonsDisponibles];
                    while (this.pockemonsJ2.length < 5 && disponibles.length > 0) {
                        const index = Math.floor(Math.random() * disponibles.length);
                        this.pockemonsJ2.push(disponibles.splice(index, 1)[0]);
                    }
                },

                async confirmarSeleccion() {
                    const jugador = this.jugadorActual;
                    const equipo = jugador === 'J1' ? this.pockemonsJ1 : this.pockemonsJ2;
                    
                    equipo.splice(0, equipo.length, ...this.seleccionados);
                    
                    for (const pokemon of equipo) {
                        if (!pokemon.movesWithPower.length) {
                            await this.procesarMovimientos(pokemon);
                        }
                    }
                    
                    this.cerrarModal();
                    
                    // Si se juega contra la máquina, seleccionar Pokémon automáticamente
                    if (this.modoJuego === 'maquina' && this.pockemonsJ2.length === 0) {
                        await this.seleccionarAleatorioMaquina();
                    }

                    if (this.pockemonsJ1.length === 5 && this.pockemonsJ2.length === 5) {
                        this.iniciarJuego = true;
                    }
                },

                cerrarModal() {
                    this.mostrarModalJ1 = false;
                    this.mostrarModalJ2 = false;
                    this.seleccionados = [];
                },

                // Sistema de batalla
                dragStart(jugador, index) {
                    const equipo = jugador === 'J1' ? this.pockemonsJ1 : this.pockemonsJ2;
                    if (!equipo[index].dead) {
                        this[`carta${jugador}`] = equipo[index];
                    }
                },

                dropCard(jugador) {
                    const carta = this[`carta${jugador}`];
                    if (carta && !carta.dead) {
                        this[`vida${jugador}`] = carta.hp;
                        if (this.cartaJ1 && this.cartaJ2) {
                            this.iniciarBatalla();
                        }
                    }
                },

                iniciarBatalla() {
                    this.mostrarBatalla = true;
                    this.batallaTerminada = false;
                    this.registro = [];
                    this.turno = Math.random() < 0.5 ? 'J1' : 'J2';
                    this.pistaAudio = "batalla.mp3";
                },

                async realizarAtaque(ataque) {
                    const atacante = this.turno === 'J1' ? this.cartaJ1 : this.cartaJ2;
                    const defensor = this.turno === 'J1' ? this.cartaJ2 : this.cartaJ1;
                    
                    const danio = Math.max(0, Math.round(
                        ataque.power + 
                        atacante.attack - 
                        (defensor.defense / 2)
                    ));
                    
                    this[`vida${this.turno === 'J1' ? 'J2' : 'J1'}`] -= danio;
                    this.registro.unshift(`${atacante.name} usa ${ataque.name} (${danio} daño)`);

                    if (this.vidaJ1 <= 0 || this.vidaJ2 <= 0) {
                        this.finalizarBatalla();
                    } else {
                        this.turno = this.turno === 'J1' ? 'J2' : 'J1';
                    }
                },

                finalizarBatalla() {
                    this.batallaTerminada = true;
                    const ganador = this.vidaJ1 > 0 ? 'J1' : 'J2';
                    this.resultado = `¡${this[`carta${ganador}`].name} gana!`;
                    
                    // Marcar Pokémon derrotado
                    const perdedor = ganador === 'J1' ? this.cartaJ2 : this.cartaJ1;
                    perdedor.dead = true;
                },

                cerrarBatalla() {
                    this.mostrarBatalla = false;
                    this.cartaJ1 = null;
                    this.cartaJ2 = null;
                    this.pistaAudio = "inicio.mp3";
                },

                // Helpers
                async procesarMovimientos(pokemon) {
                    if (pokemon.movesWithPower.length) return;
                    
                    const moves = await Promise.all(
                        pokemon.moves.slice(0, 15).map(async move => {
                            const res = await fetch(move.move.url);
                            const data = await res.json();
                            return {
                                name: move.move.name,
                                power: data.power || 40
                            };
                        })
                    );
                    
                    pokemon.movesWithPower = moves
                        .filter(m => m.power > 0)
                        .sort((a, b) => b.power - a.power)
                        .slice(0, 5);
                }
            },
            mounted() {
                this.ObtenerPokemons();
            }
        }).mount('#app');
    </script>
</body>

</html>